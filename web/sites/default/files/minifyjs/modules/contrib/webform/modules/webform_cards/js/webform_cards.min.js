(function($,Drupal){Drupal.webform=Drupal.webform||{};Drupal.webform.cards=Drupal.webform.cards||{};Drupal.webform.cards.autoForwardDelay=Drupal.webform.cards.autoForwardDelay||250;Drupal.behaviors.webformCards={attach:function(context){var $forms=$(context).is('form.webform-submission-form')?$(context):$('form.webform-submission-form',context);$(once('webform-cards',$forms)).each(function(){var $form=$(this);var options={progressStates:$form[0].hasAttribute('data-progress-states'),progressLink:$form[0].hasAttribute('data-progress-link'),autoForward:$form[0].hasAttribute('data-auto-forward'),autoForwardHideNextButton:$form[0].hasAttribute('data-auto-forward-hide-next-button'),keyboard:$form[0].hasAttribute('data-keyboard'),previewLink:$form[0].hasAttribute('data-preview-link'),confirmation:$form[0].hasAttribute('data-confirmation'),track:$form.data('track'),toggle:$form[0].hasAttribute('data-toggle'),toggleHideLabel:$form.data('toggle-hide-label'),toggleShowLabel:$form.data('toggle-show-label'),ajaxEffect:$form.data('ajax-effect'),ajaxSpeed:$form.data('ajax-speed'),ajaxScrollTop:$form.data('ajax-scroll-top')};var currentPage=$form.data('current-page');var $progress=$('.webform-progress');var $currentCardInput=$form.find(':input[name="current_card"]');var $allCards=$form.find('.webform-card');var $formActions=$form.find('.form-actions').show();var $previewButton=$formActions.find('.webform-button--preview');var $submitButton=$formActions.find('.webform-button--submit');var $previousButton=$formActions.find('.webform-button--previous');var $nextButton=$formActions.find('.webform-button--next');if(!$allCards.length){setPreview();return}
if(options.toggle){setToggle()}
var $invalidCards=$allCards.filter(':has(.form-item--error-message)');if($invalidCards.length){$form.find('.webform-progress').hide();$previousButton.hide();$nextButton.hide();$invalidCards.addClass('webform-card--error');shake($invalidCards);return}
$previousButton.data('default-label',$previousButton.val());$nextButton.data('default-label',$nextButton.val());$previousButton.on('click',previousButtonClickEventHandler).show();$nextButton.on('click',nextButtonClickEventHandler).show();if(options.autoForward){$form.find('input').not(':button, :submit, :reset, :image, :file').on('keydown',function(event){if(event.which===13){autoForwardEventHandler(event);event.preventDefault();return!1}});$form.find('select[data-images]:not([multiple]), input[type="range"].form-webform-rating').on('change',autoForwardEventHandler);$form.find('input:radio, label[for]').on('mouseup',function(event){var $radio=(event.target.tagName==='LABEL')?$('#'+$(event.target).attr('for')):$(this);if($radio.is(':radio')&&$radio.val()!=='_other_'){setTimeout(function(){autoForwardEventHandler(event)})}})}
if(options.keyboard){$('body').on('keydown',function(event){if(event.which!==37&&event.which!==39){return}
if(typeof event.target.value!=='undefined'&&typeof event.target.selectionStart!=='undefined'&&event.target.selectionStart!==null){if(event.target.value.length!==event.target.selectionStart){return}
if(event.target.value.length&&event.which===37){return}}
if(event.target.tagName==='INPUT'&&event.target.type==='radio'){return}
switch(event.which){case 37:setTimeout(function(){$previousButton.trigger('click')},Drupal.webform.cards.autoForwardDelay);break;case 39:setTimeout(function(){$nextButton.trigger('click')},Drupal.webform.cards.autoForwardDelay);break}})}
if(options.progressStates){$(document).on('state:visible state:visible-slide',function stateVisibleEventHandler(e){if($(e.target).hasClass('webform-card')&&$.contains($form[0],e.target)){trackProgress();trackActions()}})}
$allCards.on('webform_cards:set_active_card',function(event){var $activeCard=$(event.target);setActiveCard($activeCard)});initialize();function initialize(){var currentCard=$currentCardInput.val();var $activeCard=currentCard?$allCards.filter('[data-webform-key="'+currentCard+'"]'):[];if(!$activeCard.length){$activeCard=$allCards.first()}
setActiveCard($activeCard,!0)}
function setActiveCard($activeCard,initialize){if(!$activeCard.length){return}
var $prevCard=$allCards.filter('.webform-card--active');$prevCard.removeClass('webform-card--active');$activeCard.addClass('webform-card--active');$form.trigger('webform_cards:change',[$activeCard]);$activeCard=$allCards.filter('.webform-card--active');if($activeCard.get(0)===$prevCard.get(0)){initialize=!0}
if(!initialize){applyAjaxEffect($activeCard);Drupal.webformScrollTop($activeCard,options.ajaxScrollTop)}
autofocus($activeCard);$currentCardInput.val($activeCard.data('webform-key'));$form.attr('data-webform-current-card',$activeCard.data('webform-key'));trackCurrentPage($activeCard);trackProgress();trackActions()}
function trackCurrentPage($activeCard){if(!options.track){return}
var page=(options.track==='index')?($allCards.index($activeCard)+1):$activeCard.data('webform-key');$form.data('webform-wizard-current-page',page);var url=window.location.toString();var regex=/([?&])page=[^?&]+/;if(url.match(regex)){url=url.replace(regex,'$1page='+page)}else{url=url+(url.indexOf('?')!==-1?'&page=':'?page=')+page}
window.history.replaceState(null,null,url)}
function trackActions(){var $activeCard=$allCards.filter('.webform-card--active');setButtonLabel($previousButton,$activeCard.data('prev-button-label')||$previousButton.data('default-label'));setButtonLabel($nextButton,$activeCard.data('next-button-label')||$nextButton.data('default-label'));var hasPrevCard=!!$activeCard.prevAll('.webform-card:not([style*="display: none"])').length;$previousButton.toggle(hasPrevCard);var hasNextCard=!!$activeCard.nextAll('.webform-card:not([style*="display: none"])').length;$previewButton.toggle(!hasNextCard);$submitButton.toggle(!hasNextCard);$nextButton.toggle(hasNextCard);if(hideAutoForwardNextButton()){$nextButton.hide()}}
function trackProgress(){var cards=getCardsProgressSteps();for(var i=0;i<cards.length;i++){var card=cards[i];var cardAttributeName='[data-webform-'+card.type+'="'+card.key+'"]';var $cardStep=$progress.find(cardAttributeName);$cardStep.find('[data-webform-progress-step]').attr('data-text',card.step);if(card.type==='page'){continue}
$cardStep.toggle(!card.hidden);$cardStep.toggleClass('is-active',card.active);$cardStep.toggleClass('is-complete',!card.active&&card.complete);var $cardState=$cardStep.find('[data-webform-progress-state]');$cardState.toggle(card.active||card.complete);if(card.active){$cardState.html(Drupal.t('Current'))}
if(card.complete){$cardState.html(Drupal.t('Complete'))}
if(options.progressLink){var $links=$cardStep.find('[data-webform-progress-link]');$links.data('webform-key',card.key);if(card.complete){if($links.attr('role')!=='link'){$links.attr({'role':'link','title':card.title,'aria-label':card.title,'tabindex':'0'}).on('click',function(){var $card=$allCards.filter('[data-webform-key="'+$(this).data('webform-key')+'"]');setActiveCard($card)}).on('keydown',function(event){if(event.which===13){var $card=$allCards.filter('[data-webform-key="'+$(this).data('webform-key')+'"]');setActiveCard($card)}})}}else if($links.attr('role')==='link'){$links.removeAttr('role title aria-label tabindex').off('click keydown')}}}
var properties=getCardsProgressProperties();for(var property in properties){if(properties.hasOwnProperty(property)){var attribute='[data-webform-progress-'+property+']';var value=properties[property];$progress.find(attribute).html(value)}}
$progress.find('progress').attr({value:properties.index,max:properties.total})}
function setToggle(){var $toggle=$('<button type="button" class="webform-cards-toggle"></button>').html(options.toggleShowLabel).on('click',toggleEventHandler).wrap('<div class="webform-cards-toggle-wrapper"></div>').parent();$allCards.eq(0).before($toggle)}
function setPreview(){if(currentPage!=='webform_preview'||!$form.find('.webform-preview').length){return}
if(options.keyboard){$('body').on('keydown',function(event){switch(event.which){case 37:setTimeout(function(){$previousButton.trigger('click')},Drupal.webform.cards.autoForwardDelay);break;case 39:setTimeout(function(){$submitButton.trigger('click')},Drupal.webform.cards.autoForwardDelay);break}})}
setPreviewLinks()}
function setPreviewLinks(){var $button=$form.find('.js-webform-wizard-pages-link[data-webform-page="webform_start"]');if(options.progressLink){$progress.find('[data-webform-card]').each(function(){var $step=$(this);var card=$step.data('webform-card');var title=$step.attr('title');$step.find('[data-webform-progress-link]').attr({'role':'link','title':title,'aria-label':title,'tabindex':'0'}).on('click',function(){$currentCardInput.val(card);$button.trigger('click')}).on('keydown',function(event){if(event.which===13){$(this).trigger('click')}})})}
if(options.previewLink){$form.find('.webform-card-edit[data-webform-card]').each(function appendEditButton(){var $card=$(this);var card=$card.data('webform-card');var title=$card.attr('title');var $cardButton=$button.clone();$cardButton.removeAttr('data-webform-page data-msg-required').attr('id',$cardButton.attr('id')+'-'+card).attr('name',$cardButton.attr('name')+'-'+card).attr('data-drupal-selector',$cardButton.attr('data-drupal-selector')+'-'+card).attr('title',Drupal.t("Edit '@title'",{'@title':title}).toString()).on('click',function(){$currentCardInput.val(card);$button.trigger('click');return!1});$card.append($cardButton).show()})}}
function getCardsProgressProperties(){var $activeCard=$allCards.filter('.webform-card--active');var $visibleCards=$allCards.filter(':not([style*="display: none"])');var index=(currentPage==='webform_preview')?$visibleCards.length+1:$visibleCards.index($activeCard);var total=$visibleCards.length+($previewButton.length?1:0)+(options.confirmation?1:0);var percentage=Math.round((index/(total-1))*100);var summary=Drupal.t('@index of @total',{'@index':index+1,'@total':total});return{index:index+1,total:total,percentage:percentage+'%',summary:summary}}
function getCardsProgressSteps(){var $activeCard=$allCards.filter('.webform-card--active');var activeKey=$activeCard.data('webform-key');var cards=[];var step=0;var isComplete=!0;$allCards.each(function(){var $card=$(this);var key=$card.data('webform-key');var title=$card.data('title');var isActive=(activeKey===key);if(isActive){isComplete=!1}
var isHidden=!1;if(options.progressStates){isHidden=$card.is('[style*="display: none"]');if(!isHidden){step++}}else{step++}
cards.push({type:'card',key:key,title:title,step:isHidden?null:step,hidden:isHidden,active:isActive,complete:isComplete})});$(['webform_preview','webform_confirmation']).each(function(){var $progressStep=$form.find('[data-webform-progress-steps] [data-webform-page="'+this+'"]');if($progressStep.length){step++;cards.push({type:'page',key:this,step:step})}});return cards}
function applyAjaxEffect($elements){switch(options.ajaxEffect){case 'fade':$elements.hide().fadeIn(options.ajaxSpeed);break;case 'slide':$elements.hide().slideDown(options.ajaxSpeed);break}}
function toggleEventHandler(event){if($form.hasClass('webform-cards-toggle-show')){$form.removeClass('webform-cards-toggle-show');$(this).attr('title',options.toggleShowLabel).html(options.toggleShowLabel);var $activeCard=$allCards.filter('.webform-card--active');setActiveCard($activeCard)}else{$form.addClass('webform-cards-toggle-show');$(this).attr('title',options.toggleHideLabel).html(options.toggleHideLabel);var $visibleCards=$allCards.filter(':not([style*="display: none"])');applyAjaxEffect($visibleCards);$nextButton.hide();$previousButton.hide();$previewButton.show();$submitButton.show();$form.trigger('webform_cards:change')}}
function previousButtonClickEventHandler(event){var $previousCard=$allCards.filter('.webform-card--active').prevAll('.webform-card:not([style*="display: none"])').first();setActiveCard($previousCard);event.preventDefault()}
function nextButtonClickEventHandler(event){var validator=$form.validate(drupalSettings.cvJqueryValidateOptions);if(!$form.valid()){validator.focusInvalid();var $activeCard=$allCards.filter('.webform-card--active');shake($activeCard)}else{var $nextCard=$allCards.filter('.webform-card--active').nextAll('.webform-card:not([style*="display: none"])').first();if($nextCard.length){setActiveCard($nextCard)}else if($previewButton.length){$previewButton.trigger('click')}else{$submitButton.trigger('click')}}
event.preventDefault()}
function autoForwardEventHandler(event){if($form.hasClass('webform-cards-toggle-show')){return}
var $activeCard=$allCards.filter('.webform-card--active');var $allInputs=$activeCard.find('input:visible, select:visible, textarea:visible');var $autoForwardInputs=$activeCard.find('input:visible, select:visible');if(!$autoForwardInputs.length||$allInputs.length!==$autoForwardInputs.length){return}
var inputValues=[];$autoForwardInputs.each(function(){var name=this.name;if(!(name in inputValues)){inputValues[name]=!1}
if(this.type==='radio'&&this.checked){inputValues[name]=!0}else if(this.type==='select-one'&&this.selectedIndex!==-1){inputValues[name]=!0}else if(this.type==='range'&&this.value){inputValues[name]=!0}});if(Object.keys(inputValues).length>1){return}
var inputHasValue=inputValues.every(function(value){return value});if(inputHasValue){setTimeout(function(){$nextButton.trigger('click')},Drupal.webform.cards.autoForwardDelay)}}
function hideAutoForwardNextButton(){if(!options.autoForwardHideNextButton){return!1}
if($form.hasClass('webform-cards-toggle-show')){return!1}
var $activeCard=$allCards.filter('.webform-card--active');var $allInputs=$activeCard.find('input:visible, select:visible, textarea:visible');var $autoForwardInputs=$activeCard.find('input[type="radio"], select[data-images]:not([multiple]), input[type="range"].form-webform-rating');if(!$autoForwardInputs.length||$allInputs.length!==$autoForwardInputs.length){return!1}
var inputValues=[];var name;var type;$autoForwardInputs.each(function(){name=this.name;type=this.type;if(type==='radio'){inputValues[name]='radio'}else if(type==='select-one'){inputValues[name]='select-one'}else if(type==='range'){inputValues[name]='range'}});if(Object.keys(inputValues).length!==1){return!1}
switch(type){case 'radio':return $('[name="'+name+'"]:checked').length?!1:!0;case 'range':return $('[name="'+name+'"]').val()!=='0'?!1:!0;case 'select-one':return $('[name="'+name+'"]').val()?!1:!0}}
function autofocus($activeCard){if(!$form.hasClass('js-webform-autofocus')){return}
var $firstInput=$activeCard.find(':input:visible:not([type="submit"])').first();if($firstInput.length&&!inputHasValue($firstInput)){$firstInput.trigger('focus')}}
function shake($element){var intShakes=3;var intDistance=20;var intDuration=450;$element.css('position','relative');for(var x=1;x<=intShakes;x++){$element.animate({left:(intDistance*-1)},((intDuration/intShakes)/4)).animate({left:intDistance},((intDuration/intShakes)/2)).animate({left:0},((intDuration/intShakes)/4))}}
function inputHasValue($input){var type=$input[0].type;var name=$input[0].name;switch(type){case 'checkbox':case 'radio':return $('[name="'+name+'"]:checked').length?!0:!1;case 'range':return $('[name="'+name+'"]').val()!=='0'?!0:!1;case 'select-one':default:return $('[name="'+name+'"]').val()?!0:!1}}
function setButtonLabel($button,label){if($button[0].tagName==='BUTTON'){$button.html(label)}else{$button.val(label)}}})}}})(jQuery,Drupal)